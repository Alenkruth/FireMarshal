#!/bin/bash

if [ -z "$1" ]; then
    output_fname="hpm_counters"
else
    output_fname=$1
fi
output_dir=/hpm_data
mkdir -p $output_dir
num_harts=`grep -o 'hart' /proc/cpuinfo | wc -l`
hpm_pids=()
for ((i=0;i<$num_harts;i++))
do
    mask_decimal=$[ 1 << $i ]
    hpm_counters > $output_dir/${output_fname}$i &
    hpm_pids+=($!)
    taskset -p `printf %x $mask_decimal` $!
done
#Disable signal used to start hpm_counters for lab2
#Consider removing the sleep below
#sleep 1
#
#for pid in "${hpm_pids[@]}"; do
#    kill -s USR1 $pid
#done
